<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Toyota • Payment & Tax Visualization</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <style>
    :root{
      --toyota-red:#EB0A1E; /* Toyota brand red */
      --bg:#ffffff; --text:#0f0f0f; --muted:#f4f4f4; --ink-2:#666; --ink-3:#999; --border:#e8e8e8;
      --card-shadow: 0 8px 24px rgba(0,0,0,.06), 0 2px 8px rgba(0,0,0,.04);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    html{scroll-behavior:auto}
    body{overscroll-behavior:contain}
    @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(235,10,30,.35)}100%{box-shadow:0 0 0 6px rgba(235,10,30,0)}}
    .pulse{animation:pulse .9s ease-out 1}

    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans",sans-serif}
    a{color:var(--toyota-red);text-decoration:none}
    header{
      
      background:linear-gradient(0deg, rgba(235,10,30,.96), rgba(235,10,30,.96)), url('');
      color:#fff;border-bottom:1px solid rgba(255,255,255,.08)
    }
    .wrap{max-width:1200px;margin:0 auto;padding:18px}
    .brand{display:flex;align-items:center;gap:14px}
    .brand img{height:36px;filter:drop-shadow(0 1px 0 rgba(0,0,0,.15))}
    .brand h1{font-size:18px;margin:0;font-weight:600;letter-spacing:.3px}

    .grid{display:grid;gap:22px;grid-template-columns:1.2fr .8fr}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

    .card{background:#fff;border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--card-shadow)}
    .card h3{margin:0 0 8px;font-size:16px}
    .card .pad{padding:16px 18px}

    .chart-card{padding:14px 16px 18px}
    canvas{width:100%;height:420px;}
    .chart-subtitle{font-size:12px;color:var(--ink-2);margin-top:6px}

    .kpis{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    @media (max-width: 560px){ .kpis{grid-template-columns:1fr} }
    .kpi{padding:14px 16px;border-radius:14px;border:1px solid var(--border);background:var(--muted)}
    .kpi .label{font-size:12px;color:var(--ink-3)}
    .kpi .value{font-size:18px;font-weight:600}

    .note{display:flex;gap:10px;align-items:flex-start;padding:12px 14px;border-radius:12px;background:#fff7f7;border:1px solid #ffd9de}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#ffe0e3;color:#a30717;font-weight:600;font-size:12px;letter-spacing:.2px}

    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 8px;border-bottom:1px dashed var(--border);font-size:12px;text-align:right;white-space:nowrap}
    th:first-child, td:first-child{text-align:left}
    tbody tr:hover{background:#fafafa}

    footer{margin-top:24px;border-top:1px solid var(--border)}
    .fine{font-size:12px;color:var(--ink-3)}

    .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn{appearance:none;border:1px solid var(--border);background:#fff;border-radius:12px;padding:8px 12px;font-weight:600;cursor:pointer}
    .btn.primary{background:var(--toyota-red);border-color:var(--toyota-red);color:#fff}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="brand">
        <!-- If the image below doesn't load, replace src with a local file e.g. ./toyota-logo.svg -->
        <img alt="Toyota logo" src="data:image/png;base64,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" />
        <h1>Toyota • Payment & Tax Visualization</h1>
      </div>
    </div>
  </header>

  <div class="wrap" style="padding-top:22px;">
    <div class="toolbar" style="margin-bottom:12px">
      <span class="pill">Static demo</span>
      <button class="btn primary" id="btnFocusBar">Focus: Stacked Payments</button>
      <button class="btn" id="btnFocusLine">Focus: Cumulative</button>
      <button class="btn" id="btnDownload">Download JSON</button>
    </div>

    <div class="grid">
      <section class="card chart-card" aria-labelledby="stacked-title">
        <h3 id="stacked-title">Installment Breakdown (Principal • Interest • Tax)</h3>
        <canvas id="stackedChart" aria-label="Stacked bar chart of payments"></canvas>
        <div class="chart-subtitle">Amounts shown per month across the loan term.
          Animations & zoom are disabled for a stable customer-facing view.
        </div>
      </section>

      <aside class="card pad">
        <h3>Summary</h3>
        <div class="kpis" id="kpis"></div>
        <div class="note" style="margin-top:12px">
          <strong>Note:</strong>
          <div id="notes"></div>
        </div>
      </aside>

      <section class="card chart-card" aria-labelledby="trend-title">
        <h3 id="trend-title">Cumulative Interest & Total Paid Over Time</h3>
        <canvas id="trendChart" aria-label="Line chart of cumulative totals"></canvas>
        <div class="chart-subtitle">Track how total interest and total outlay grow month over month.</div>
      </section>

      <section class="card pad" aria-labelledby="schedule-title">
        <h3 id="schedule-title">Amortization Schedule (Monthly)</h3>
        <div style="max-height:360px;overflow:auto;border:1px solid var(--border);border-radius:12px">
          <table>
            <thead>
              <tr>
                <th>Month</th>
                <th>Base</th>
                <th>Principal</th>
                <th>Interest</th>
                <th>Tax</th>
                <th>Total</th>
                <th>Balance End</th>
              </tr>
            </thead>
            <tbody id="tblBody"></tbody>
          </table>
        </div>
      </section>
    </div>

    <footer class="wrap" style="padding-left:0;padding-right:0">
      <p class="fine">For demonstration only. Actual tax handling can differ (Texas commonly applies sales tax upfront on vehicle purchases). This view follows your monthly-tax spec.</p>
    </footer>
  </div>

  <!-- Embed your provided JSON below (exactly as-is) -->
  <script id="financeData" type="application/json">{
  "meta": {
    "mode": "monthly_tax_visualization",
    "notes": [
      "Dallas default tax 8.25% applied to each monthly payment for visualization.",
      "Texas commonly taxes auto purchases upfront; this demo treats tax as monthly per your spec."
    ]
  },
  "chartjs": {
    "labels": [
      "1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36","37","38","39","40","41","42","43","44","45","46","47","48","49","50","51","52","53","54","55","56","57","58","59","60"
    ],
    "datasets": [
      {"label":"Principal","type":"bar","stack":"payment","data":[409.55,411.09,412.63,414.18,415.73,417.29,418.86,420.43,422,423.59,425.18,426.77,428.37,429.98,431.59,433.21,434.83,436.46,438.1,439.74,441.39,443.05,444.71,446.38,448.05,449.73,451.42,453.11,454.81,456.51,458.23,459.94,461.67,463.4,465.14,466.88,468.63,470.39,472.15,473.92,475.7,477.49,479.28,481.07,482.88,484.69,486.51,488.33,490.16,492,493.84,495.7,497.56,499.42,501.29,503.17,505.06,506.95,508.86,510.76]},
      {"label":"Interest","type":"bar","stack":"payment","data":[103.13,101.59,100.05,98.5,96.95,95.39,93.82,92.25,90.68,89.09,87.5,85.91,84.31,82.7,81.09,79.47,77.85,76.22,74.58,72.94,71.29,69.63,67.97,66.3,64.63,62.95,61.26,59.57,57.87,56.17,54.45,52.74,51.01,49.28,47.54,45.8,44.05,42.29,40.53,38.76,36.98,35.19,33.4,31.61,29.8,27.99,26.17,24.35,22.52,20.68,18.84,16.98,15.12,13.26,11.39,9.51,7.62,5.73,3.82,1.92]},
      {"label":"Tax","type":"bar","stack":"payment","data":[42.3,42.3,42.3,42.3,42.3,42.3,42.3,42.3,42.3,42.3,42.3,42.3,42.3,42.3,42.3,42.3,42.3,42.3,42.3,42.3,42.3,42.3,42.3,42.3,42.3,42.3,42.3,42.3,42.3,42.3,42.3,42.3,42.3,42.3,42.3,42.3,42.3,42.3,42.3,42.3,42.3,42.3,42.3,42.3,42.3,42.3,42.3,42.3,42.3,42.3,42.3,42.3,42.3,42.3,42.3,42.3,42.3,42.3,42.3,42.3]}
    ]
  },
  "timeseries": {
    "cumulative_interest":[103.13,204.72,304.77,403.27,500.22,595.61,689.43,781.68,872.36,961.45,1048.95,1134.86,1219.17,1301.87,1382.96,1462.43,1540.28,1616.5,1691.08,1764.02,1835.31,1904.94,1972.91,2039.21,2103.84,2166.79,2228.05,2287.62,2345.49,2401.66,2456.11,2508.85,2559.86,2609.14,2656.68,2702.48,2746.53,2788.82,2829.35,2868.11,2905.09,2940.28,2973.68,3005.29,3035.09,3063.08,3089.25,3113.6,3136.12,3156.8,3175.64,3192.62,3207.74,3221,3232.39,3241.9,3249.52,3255.25,3259.07,3260.99],
    "cumulative_total_paid":[554.98,1109.96,1664.94,2219.92,2774.9,3329.88,3884.86,4439.84,4994.82,5549.8,6104.78,6659.76,7214.74,7769.72,8324.7,8879.68,9434.66,9989.64,10544.62,11099.6,11654.58,12209.56,12764.54,13319.52,13874.5,14429.48,14984.46,15539.44,16094.42,16649.4,17204.38,17759.36,18314.34,18869.32,19424.3,19979.28,20534.26,21089.24,21644.22,22199.2,22754.18,23309.16,23864.14,24419.12,24974.1,25529.08,26084.06,26639.04,27194.02,27749,28303.98,28858.96,29413.94,29968.92,30523.9,31078.88,31633.86,32188.84,32743.82,33298.8],
    "payment_total_per_month":[554.98,554.98,554.98,554.98,554.98,554.98,554.98,554.98,554.98,554.98,554.98,554.98,554.98,554.98,554.98,554.98,554.98,554.98,554.98,554.98,554.98,554.98,554.98,554.98,554.98,554.98,554.98,554.98,554.98,554.98,554.98,554.98,554.98,554.98,554.98,554.98,554.98,554.98,554.98,554.98,554.98,554.98,554.98,554.98,554.98,554.98,554.98,554.98,554.98,554.98,554.98,554.98,554.98,554.98,554.98,554.98,554.98,554.98,554.98,554.98]
  },
  "totals": {
    "assumed_vehicle_price": 27500,
    "down_payment_cash": 0,
    "amount_financed": 27500,
    "apr_percent": 4.5,
    "term_months": 60,
    "tax_rate": 0.08,
    "monthly_payment_base": 512.68,
    "monthly_tax": 42.3,
    "monthly_payment_total": 554.98,
    "total_interest": 3260.99,
    "total_tax_paid": 2538,
    "total_paid_including_tax": 33298.8,
    "customer_due_at_signing": 0,
    "principal_repaid": 27500
  },
  "schedule": [
    {"period":1,"payment_base":"512.68","interest":"103.13","principal":"409.55","tax":"42.30","payment_total":"554.98","balance_end":"27090.45"},
    {"period":2,"payment_base":"512.68","interest":"101.59","principal":"411.09","tax":"42.30","payment_total":"554.98","balance_end":"26679.36"},
    {"period":3,"payment_base":"512.68","interest":"100.05","principal":"412.63","tax":"42.30","payment_total":"554.98","balance_end":"26266.73"},
    {"period":4,"payment_base":"512.68","interest":"98.50","principal":"414.18","tax":"42.30","payment_total":"554.98","balance_end":"25852.55"},
    {"period":5,"payment_base":"512.68","interest":"96.95","principal":"415.73","tax":"42.30","payment_total":"554.98","balance_end":"25436.82"},
    {"period":6,"payment_base":"512.68","interest":"95.39","principal":"417.29","tax":"42.30","payment_total":"554.98","balance_end":"25019.53"},
    {"period":7,"payment_base":"512.68","interest":"93.82","principal":"418.86","tax":"42.30","payment_total":"554.98","balance_end":"24600.67"},
    {"period":8,"payment_base":"512.68","interest":"92.25","principal":"420.43","tax":"42.30","payment_total":"554.98","balance_end":"24180.24"},
    {"period":9,"payment_base":"512.68","interest":"90.68","principal":"422.00","tax":"42.30","payment_total":"554.98","balance_end":"23758.24"},
    {"period":10,"payment_base":"512.68","interest":"89.09","principal":"423.59","tax":"42.30","payment_total":"554.98","balance_end":"23334.65"},
    {"period":11,"payment_base":"512.68","interest":"87.50","principal":"425.18","tax":"42.30","payment_total":"554.98","balance_end":"22909.47"},
    {"period":12,"payment_base":"512.68","interest":"85.91","principal":"426.77","tax":"42.30","payment_total":"554.98","balance_end":"22482.70"},
    {"period":13,"payment_base":"512.68","interest":"84.31","principal":"428.37","tax":"42.30","payment_total":"554.98","balance_end":"22054.33"},
    {"period":14,"payment_base":"512.68","interest":"82.70","principal":"429.98","tax":"42.30","payment_total":"554.98","balance_end":"21624.35"},
    {"period":15,"payment_base":"512.68","interest":"81.09","principal":"431.59","tax":"42.30","payment_total":"554.98","balance_end":"21192.76"},
    {"period":16,"payment_base":"512.68","interest":"79.47","principal":"433.21","tax":"42.30","payment_total":"554.98","balance_end":"20759.55"},
    {"period":17,"payment_base":"512.68","interest":"77.85","principal":"434.83","tax":"42.30","payment_total":"554.98","balance_end":"20324.72"},
    {"period":18,"payment_base":"512.68","interest":"76.22","principal":"436.46","tax":"42.30","payment_total":"554.98","balance_end":"19888.26"},
    {"period":19,"payment_base":"512.68","interest":"74.58","principal":"438.10","tax":"42.30","payment_total":"554.98","balance_end":"19450.16"},
    {"period":20,"payment_base":"512.68","interest":"72.94","principal":"439.74","tax":"42.30","payment_total":"554.98","balance_end":"19010.42"},
    {"period":21,"payment_base":"512.68","interest":"71.29","principal":"441.39","tax":"42.30","payment_total":"554.98","balance_end":"18569.03"},
    {"period":22,"payment_base":"512.68","interest":"69.63","principal":"443.05","tax":"42.30","payment_total":"554.98","balance_end":"18125.98"},
    {"period":23,"payment_base":"512.68","interest":"67.97","principal":"444.71","tax":"42.30","payment_total":"554.98","balance_end":"17681.27"},
    {"period":24,"payment_base":"512.68","interest":"66.30","principal":"446.38","tax":"42.30","payment_total":"554.98","balance_end":"17234.89"},
    {"period":25,"payment_base":"512.68","interest":"64.63","principal":"448.05","tax":"42.30","payment_total":"554.98","balance_end":"16786.84"},
    {"period":26,"payment_base":"512.68","interest":"62.95","principal":"449.73","tax":"42.30","payment_total":"554.98","balance_end":"16337.11"},
    {"period":27,"payment_base":"512.68","interest":"61.26","principal":"451.42","tax":"42.30","payment_total":"554.98","balance_end":"15885.69"},
    {"period":28,"payment_base":"512.68","interest":"59.57","principal":"453.11","tax":"42.30","payment_total":"554.98","balance_end":"15432.58"},
    {"period":29,"payment_base":"512.68","interest":"57.87","principal":"454.81","tax":"42.30","payment_total":"554.98","balance_end":"14977.77"},
    {"period":30,"payment_base":"512.68","interest":"56.17","principal":"456.51","tax":"42.30","payment_total":"554.98","balance_end":"14521.26"},
    {"period":31,"payment_base":"512.68","interest":"54.45","principal":"458.23","tax":"42.30","payment_total":"554.98","balance_end":"14063.03"},
    {"period":32,"payment_base":"512.68","interest":"52.74","principal":"459.94","tax":"42.30","payment_total":"554.98","balance_end":"13603.09"},
    {"period":33,"payment_base":"512.68","interest":"51.01","principal":"461.67","tax":"42.30","payment_total":"554.98","balance_end":"13141.42"},
    {"period":34,"payment_base":"512.68","interest":"49.28","principal":"463.40","tax":"42.30","payment_total":"554.98","balance_end":"12678.02"},
    {"period":35,"payment_base":"512.68","interest":"47.54","principal":"465.14","tax":"42.30","payment_total":"554.98","balance_end":"12212.88"},
    {"period":36,"payment_base":"512.68","interest":"45.80","principal":"466.88","tax":"42.30","payment_total":"554.98","balance_end":"11746.00"},
    {"period":37,"payment_base":"512.68","interest":"44.05","principal":"468.63","tax":"42.30","payment_total":"554.98","balance_end":"11277.37"},
    {"period":38,"payment_base":"512.68","interest":"42.29","principal":"470.39","tax":"42.30","payment_total":"554.98","balance_end":"10806.98"},
    {"period":39,"payment_base":"512.68","interest":"40.53","principal":"472.15","tax":"42.30","payment_total":"554.98","balance_end":"10334.83"},
    {"period":40,"payment_base":"512.68","interest":"38.76","principal":"473.92","tax":"42.30","payment_total":"554.98","balance_end":"9860.91"},
    {"period":41,"payment_base":"512.68","interest":"36.98","principal":"475.70","tax":"42.30","payment_total":"554.98","balance_end":"9385.21"},
    {"period":42,"payment_base":"512.68","interest":"35.19","principal":"477.49","tax":"42.30","payment_total":"554.98","balance_end":"8907.72"},
    {"period":43,"payment_base":"512.68","interest":"33.40","principal":"479.28","tax":"42.30","payment_total":"554.98","balance_end":"8428.44"},
    {"period":44,"payment_base":"512.68","interest":"31.61","principal":"481.07","tax":"42.30","payment_total":"554.98","balance_end":"7947.37"},
    {"period":45,"payment_base":"512.68","interest":"29.80","principal":"482.88","tax":"42.30","payment_total":"554.98","balance_end":"7464.49"},
    {"period":46,"payment_base":"512.68","interest":"27.99","principal":"484.69","tax":"42.30","payment_total":"554.98","balance_end":"6979.80"},
    {"period":47,"payment_base":"512.68","interest":"26.17","principal":"486.51","tax":"42.30","payment_total":"554.98","balance_end":"6493.29"},
    {"period":48,"payment_base":"512.68","interest":"24.35","principal":"488.33","tax":"42.30","payment_total":"554.98","balance_end":"6004.96"},
    {"period":49,"payment_base":"512.68","interest":"22.52","principal":"490.16","tax":"42.30","payment_total":"554.98","balance_end":"5514.80"},
    {"period":50,"payment_base":"512.68","interest":"20.68","principal":"492.00","tax":"42.30","payment_total":"554.98","balance_end":"5022.80"},
    {"period":51,"payment_base":"512.68","interest":"18.84","principal":"493.84","tax":"42.30","payment_total":"554.98","balance_end":"4528.96"},
    {"period":52,"payment_base":"512.68","interest":"16.98","principal":"495.70","tax":"42.30","payment_total":"554.98","balance_end":"4033.26"},
    {"period":53,"payment_base":"512.68","interest":"15.12","principal":"497.56","tax":"42.30","payment_total":"554.98","balance_end":"3535.70"},
    {"period":54,"payment_base":"512.68","interest":"13.26","principal":"499.42","tax":"42.30","payment_total":"554.98","balance_end":"3036.28"},
    {"period":55,"payment_base":"512.68","interest":"11.39","principal":"501.29","tax":"42.30","payment_total":"554.98","balance_end":"2534.99"},
    {"period":56,"payment_base":"512.68","interest":"9.51","principal":"503.17","tax":"42.30","payment_total":"554.98","balance_end":"2031.82"},
    {"period":57,"payment_base":"512.68","interest":"7.62","principal":"505.06","tax":"42.30","payment_total":"554.98","balance_end":"1526.76"},
    {"period":58,"payment_base":"512.68","interest":"5.73","principal":"506.95","tax":"42.30","payment_total":"554.98","balance_end":"1019.81"},
    {"period":59,"payment_base":"512.68","interest":"3.82","principal":"508.86","tax":"42.30","payment_total":"554.98","balance_end":"510.95"},
    {"period":60,"payment_base":"512.68","interest":"1.92","principal":"510.76","tax":"42.30","payment_total":"554.98","balance_end":"0.19"}
  ]
}</script>

  <script>
    const currency = new Intl.NumberFormat(undefined,{style:'currency',currency:'USD'});

    function readData(){
      const raw = document.getElementById('financeData').textContent.trim();
      return JSON.parse(raw);
    }

    function setNotes(meta){
      const wrap = document.getElementById('notes');
      wrap.innerHTML = '';
      (meta?.notes || []).forEach(n=>{
        const p = document.createElement('p'); p.style.margin='4px 0'; p.textContent = '• ' + n; wrap.appendChild(p);
      });
    }

    function setKpis({totals}){
      const k = document.getElementById('kpis');
      const items = [
        ['Vehicle Price', currency.format(totals.assumed_vehicle_price)],
        ['Amount Financed', currency.format(totals.amount_financed)],
        ['APR', (totals.apr_percent??0) + '%'],
        ['Term', (totals.term_months??0) + ' months'],
        ['Monthly (Base)', currency.format(totals.monthly_payment_base)],
        ['Monthly Tax', currency.format(totals.monthly_tax)],
        ['Monthly (Total)', currency.format(totals.monthly_payment_total)],
        ['Total Interest', currency.format(totals.total_interest)],
        ['Total Tax', currency.format(totals.total_tax_paid)],
        ['Total Paid (incl. tax)', currency.format(totals.total_paid_including_tax)],
        ['Due at Signing', currency.format(totals.customer_due_at_signing)],
        ['Principal Repaid', currency.format(totals.principal_repaid)]
      ];
      k.innerHTML='';
      items.forEach(([label,val])=>{
        const d=document.createElement('div');d.className='kpi';
        d.innerHTML = `<div class="label">${label}</div><div class="value">${val}</div>`; k.appendChild(d);
      })
    }

    function fillTable(rows){
      const tbody = document.getElementById('tblBody'); tbody.innerHTML='';
      rows.forEach(r=>{
        const tr=document.createElement('tr');
        const c = (key)=>`<td>${key==='period'?r[key]:currency.format(parseFloat(r[key]))}</td>`;
        tr.innerHTML = `<td>${r.period}</td>${c('payment_base')}${c('principal')}${c('interest')}${c('tax')}${c('payment_total')}${c('balance_end')}`;
        tbody.appendChild(tr);
      })
    }

    // Charts
    let chartStacked, chartTrend;
    function drawCharts(d){
      const {labels, datasets} = d.chartjs;

      const ctxBar = document.getElementById('stackedChart');
      chartStacked = new Chart(ctxBar, {
        type:'bar',
        data:{labels, datasets: datasets.map(ds=>({
          ...ds,
          borderWidth:0,
          borderRadius:6,
          barPercentage:0.9,
          categoryPercentage:1.0,
          backgroundColor: ds.label==='Principal' ? '#2e7d32' : ds.label==='Interest' ? '#EB0A1E' : '#9e9e9e'
        }))},
        options:{
          animation:false, // static experience (prevents any looping/zoom perception)
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            legend:{position:'top'},
            tooltip:{mode:'index',intersect:false,callbacks:{
              label:(ctx)=>`${ctx.dataset.label}: ${currency.format(ctx.parsed.y)}`
            }}
          },
          interaction:{mode:'index',intersect:false},
          scales:{
            x:{stacked:true, grid:{display:false}},
            y:{stacked:true, beginAtZero:true, ticks:{callback:(v)=>currency.format(v)}}
          }
        }
      });

      const ctxLine = document.getElementById('trendChart');
      chartTrend = new Chart(ctxLine, {
        type:'line',
        data:{
          labels,
          datasets:[
            {label:'Cumulative Interest', data:d.timeseries.cumulative_interest, borderWidth:2, fill:false, tension:.25},
            {label:'Cumulative Total Paid', data:d.timeseries.cumulative_total_paid, borderWidth:2, fill:false, tension:.25}
          ]
        },
        options:{
          animation:false,
          responsive:true,
          maintainAspectRatio:false,
          plugins:{legend:{position:'top'}, tooltip:{callbacks:{label:(c)=>`${c.dataset.label}: ${currency.format(c.parsed.y)}`}}},
          scales:{x:{grid:{display:false}}, y:{beginAtZero:true, ticks:{callback:(v)=>currency.format(v)}}}
        }
      })
    }

    function freezeChartsNow(){
      try{
        const swap = (chart, id)=>{
          if(!chart) return;
          const canvas = document.getElementById(id);
          if(!canvas) return;
          // Convert to static image to eliminate any observers/resizing
          const url = chart.toBase64Image('image/png',1);
          const img = new Image();
          img.src = url; img.alt = canvas.getAttribute('aria-label') || 'chart';
          img.style.width = '100%'; img.style.height = '420px';
          canvas.replaceWith(img);
          chart.destroy();
        };
        swap(chartStacked,'stackedChart');
        swap(chartTrend,'trendChart');
      }catch(e){ console.error('FreezeCharts error', e); }
    }

    function downloadJSON(){ 
      const raw = document.getElementById('financeData').textContent.trim();
      const blob = new Blob([raw],{type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = Object.assign(document.createElement('a'),{href:url,download:'toyota_finance_demo.json'});
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    // Boot
    if('scrollRestoration' in history){ history.scrollRestoration='manual'; }
    const DATA = readData();
    setNotes(DATA.meta);
    setKpis(DATA);
    fillTable(DATA.schedule);
    drawCharts(DATA);
    freezeChartsNow();

    // Toolbar actions
    document.getElementById('btnDownload').addEventListener('click', downloadJSON);
    document.getElementById('btnFocusBar').addEventListener('click',()=>{
      const el=document.getElementById('stacked-title').closest('.card');
      el.classList.add('pulse'); setTimeout(()=>el.classList.remove('pulse'),900);
    });
    document.getElementById('btnFocusLine').addEventListener('click',()=>{
      const el=document.getElementById('trend-title').closest('.card');
      el.classList.add('pulse'); setTimeout(()=>el.classList.remove('pulse'),900);
    });
  </script>
</body>
</html>
